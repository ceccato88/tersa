# Documenta√ß√£o - Modelos de IA e Sistema de Filtragem

## Vis√£o Geral
Este documento mapeia onde s√£o configurados os modelos de IA (texto, imagem e v√≠deo), schemas, sistema de filtragem din√¢mica e chamadas de API no projeto Tersa.

## üîÑ Sistema de Filtragem Din√¢mica (Implementado em 2025-01-21)

### Vis√£o Geral do Sistema
Sistema que filtra dinamicamente os modelos dispon√≠veis nos n√≥s de imagem e v√≠deo baseado no tipo de conex√£o anterior na cadeia de processamento.

### Arquivos Principais

#### 1. Detector de Conex√µes
**Arquivo:** `C:\ai\tersa\lib\node-connection-detector.ts`
- **Fun√ß√£o:** `detectPreviousNodeType()` - Detecta o tipo de n√≥ conectado anteriormente
- **Tipos detectados:**
  - `none` - Nenhuma conex√£o
  - `text-primitive` - N√≥ de texto simples
  - `text-transform` - N√≥ de texto com IA
  - `image-primitive` - N√≥ de imagem simples
  - `image-transform` - N√≥ de imagem com IA
  - `video-primitive` - N√≥ de v√≠deo simples
  - `video-transform` - N√≥ de v√≠deo com IA

#### 2. Sistema de Filtragem
**Arquivo:** `C:\ai\tersa\lib\model-filtering.ts`
- **Modelos de Imagem:** Defini√ß√£o com `supportedInputs` (none, text, image, video)
- **Modelos de V√≠deo:** Defini√ß√£o com `supportedInputs` (none, text, image, video)
- **Hook:** `useFilteredModels()` - Retorna modelos filtrados para um n√≥ espec√≠fico
- **Fun√ß√µes auxiliares:**
  - `filterImageModels()` - Filtra modelos de imagem
  - `filterVideoModels()` - Filtra modelos de v√≠deo
  - `getFirstAvailableModel()` - Obt√©m primeiro modelo dispon√≠vel
  - `hasAvailableModels()` - Verifica se h√° modelos dispon√≠veis

### Regras de Filtragem

#### Para N√≥s de Imagem:
- **Sem conex√£o:** Todos os modelos text-to-image
- **Conex√£o de texto:** Modelos que suportam text-to-image
- **Conex√£o de imagem:** Modelos que suportam image-to-image
- **Conex√£o de v√≠deo:** Modelos que suportam video-to-image

#### Para N√≥s de V√≠deo:
- **Sem conex√£o:** Nenhum modelo (mensagem: "Conecte um n√≥ de imagem")
- **Conex√£o de texto:** Nenhum modelo (mensagem: "Modelos text-to-video em breve")
- **Conex√£o de imagem:** Modelos que suportam image-to-video
- **Conex√£o de v√≠deo:** Nenhum modelo (mensagem: "Modelos video-to-video em breve")

### Integra√ß√£o nos Componentes

#### N√≥s de Imagem
**Arquivo:** `C:\ai\tersa\components\nodes\image\transform.tsx`
- Importa `useFilteredModels`, `getFirstAvailableModel`
- Usa modelos filtrados no `ModelSelector`
- Aplica modelo padr√£o baseado na filtragem

#### N√≥s de V√≠deo
**Arquivo:** `C:\ai\tersa\components\nodes\video\transform.tsx`
- Importa sistema de filtragem completo
- Exibe mensagens contextuais quando n√£o h√° modelos
- Usa modelos filtrados no `ModelSelector`

## üìù Como Cadastrar Novos Modelos

### 1. Adicionando Modelos de Imagem

#### Passo 1: Definir o Modelo
**Arquivo:** `C:\ai\tersa\lib\model-filtering.ts`
```typescript
const IMAGE_MODELS = {
  'novo-modelo/versao': {
    label: 'Nome do Modelo',
    chef: providers.replicate,
    icon: IconeDoModelo,
    providers: [{
      ...providers.replicate,
      icon: IconeDoModelo,
    }],
    supportedInputs: ['none', 'text', 'image'], // Tipos de entrada suportados
    default: false, // Se √© modelo padr√£o
  },
};
```

#### Passo 2: Configurar Schema (se necess√°rio)
**Arquivo:** `C:\ai\tersa\lib\model-schemas.ts`
```typescript
export const getModelSchema = (modelId: string) => {
  switch (modelId) {
    case 'novo-modelo/versao':
      return {
        aspectRatio: { type: 'select', options: ['1:1', '16:9', '9:16'] },
        seed: { type: 'number', min: 0, max: 999999 },
        // outros par√¢metros...
      };
  }
};
```

### 2. Adicionando Modelos de V√≠deo

#### Passo 1: Definir o Modelo
**Arquivo:** `C:\ai\tersa\lib\model-filtering.ts`
```typescript
const VIDEO_MODELS = {
  'novo-video-modelo/versao': {
    label: 'Nome do Modelo de V√≠deo',
    chef: providers.replicate,
    icon: IconeDoModelo,
    providers: [{
      ...providers.replicate,
      icon: IconeDoModelo,
    }],
    supportedInputs: ['image'], // Apenas image-to-video por enquanto
    default: false,
  },
};
```

### 3. Tipos de Entrada Suportados

- **`'none'`** - Modelo pode ser usado sem conex√£o anterior (text-to-image/video)
- **`'text'`** - Modelo aceita entrada de texto
- **`'image'`** - Modelo aceita entrada de imagem
- **`'video'`** - Modelo aceita entrada de v√≠deo

### 4. Configura√ß√£o de Actions

#### Para Modelos de Imagem
**Arquivo:** `C:\ai\tersa\app\actions\image\replicate.ts`
- Adicionar l√≥gica espec√≠fica do modelo se necess√°rio
- Configurar par√¢metros espec√≠ficos

#### Para Modelos de V√≠deo
**Arquivo:** `C:\ai\tersa\app\actions\video\replicate.ts`
- Adicionar l√≥gica espec√≠fica do modelo se necess√°rio
- Configurar par√¢metros espec√≠ficos

## üß™ Como Testar o Sistema de Filtragem

### Cen√°rios de Teste

#### 1. Teste de N√≥ de Imagem Isolado
- **A√ß√£o:** Criar um n√≥ de imagem sem conex√µes
- **Resultado esperado:** Todos os modelos text-to-image dispon√≠veis
- **Verifica√ß√£o:** Seletor deve mostrar modelos como FLUX.1 [dev], FLUX.1 [schnell]

#### 2. Teste de Conex√£o Texto ‚Üí Imagem
- **A√ß√£o:** Conectar n√≥ de texto a n√≥ de imagem
- **Resultado esperado:** Modelos que suportam text-to-image
- **Verifica√ß√£o:** Filtragem baseada em `supportedInputs: ['text']`

#### 3. Teste de Conex√£o Imagem ‚Üí V√≠deo
- **A√ß√£o:** Conectar n√≥ de imagem a n√≥ de v√≠deo
- **Resultado esperado:** Modelos image-to-video (ex: WAN Video I2V)
- **Verifica√ß√£o:** Seletor deve mostrar apenas modelos compat√≠veis

#### 4. Teste de N√≥ de V√≠deo Isolado
- **A√ß√£o:** Criar um n√≥ de v√≠deo sem conex√µes
- **Resultado esperado:** Mensagem "Conecte um n√≥ de imagem para gerar v√≠deos"
- **Verifica√ß√£o:** Nenhum modelo dispon√≠vel, mensagem explicativa

### Comandos para Teste

```bash
# Subir a aplica√ß√£o
wsl pnpm dev

# Aguardar compila√ß√£o (at√© 2 minutos)
# Acessar: http://localhost:3000
```

### Debugging

#### Verificar Detec√ß√£o de Conex√µes
```typescript
// No console do navegador
console.log('Tipo de conex√£o:', detectPreviousNodeType(nodeId, nodes, edges));
```

#### Verificar Modelos Filtrados
```typescript
// No console do navegador
console.log('Modelos filtrados:', useFilteredModels('image', nodeId));
```

## üìã Checklist de Implementa√ß√£o

### ‚úÖ Conclu√≠do (2025-01-21)
- [x] Sistema de detec√ß√£o de conex√µes (`node-connection-detector.ts`)
- [x] Sistema de filtragem de modelos (`model-filtering.ts`)
- [x] Integra√ß√£o em n√≥s de imagem (`image/transform.tsx`)
- [x] Integra√ß√£o em n√≥s de v√≠deo (`video/transform.tsx`)
- [x] Mensagens contextuais para casos sem modelos
- [x] Testes b√°sicos de funcionamento

### üîÑ Pr√≥ximos Passos
- [ ] Adicionar mais modelos de imagem com diferentes `supportedInputs`
- [ ] Implementar modelos text-to-video
- [ ] Implementar modelos video-to-video
- [ ] Adicionar testes automatizados
- [ ] Otimizar performance da filtragem

## üéØ Componentes Principais

### 1. Modelos de Texto

#### Configura√ß√£o dos Modelos
**Arquivo:** `C:\ai\tersa\components\nodes\text\transform.tsx`
- **Linhas 50-65:** Defini√ß√£o dos modelos dispon√≠veis
```typescript
const AVAILABLE_MODELS = {
  'openai/gpt-5': {
    name: 'GPT-5',
    provider: 'replicate',
    default: true,
  },
  'openai/gpt-5-mini': {
    name: 'GPT-5 Mini',
    provider: 'replicate',
  },
  'anthropic/claude-4-sonnet': {
    name: 'Claude 4 Sonnet',
    provider: 'replicate',
  },
};
```

#### API de Streaming de Texto
**Arquivo:** `C:\ai\tersa\app\api\replicate-stream\route.ts`
- Endpoint personalizado para streaming de texto via Replicate
- Processa prompts, system prompts e par√¢metros
- Suporte a m√∫ltiplas varia√ß√µes
- Tratamento de imagens como input

### 2. Modelos de Imagem

#### Action para Gera√ß√£o de Imagem
**Arquivo:** `C:\ai\tersa\app\actions\image\replicate.ts`
- Implementa√ß√£o da gera√ß√£o de imagens via Replicate
- Configura√ß√£o de modelos de imagem
- Processamento de par√¢metros como aspect ratio, seed, etc.

#### Componente de Imagem
**Diret√≥rio:** `C:\ai\tersa\components\nodes\image\`
- **transform.tsx:** Componente principal de transforma√ß√£o de imagem
- **primitive.tsx:** Componente primitivo de imagem
- **index.ts:** Exports e tipos

### 3. Schemas de Modelos

#### Defini√ß√µes de Schema
**Arquivo:** `C:\ai\tersa\lib\model-schemas.ts`
- Schemas para valida√ß√£o de par√¢metros
- Defini√ß√µes de tipos para modelos
- Configura√ß√µes de campos din√¢micos

## üîß Estrutura de Configura√ß√£o

### Modelos de Texto
```
C:\ai\tersa\components\nodes\text\transform.tsx
‚îú‚îÄ‚îÄ AVAILABLE_MODELS (linhas 50-65)
‚îú‚îÄ‚îÄ getDefaultModel() (linha 67)
‚îî‚îÄ‚îÄ handleGenerate() (linha 95+)
```

### API de Texto
```
C:\ai\tersa\app\api\replicate-stream\
‚îú‚îÄ‚îÄ route.ts (endpoint principal)
‚îî‚îÄ‚îÄ Configura√ß√µes de streaming
```

### Modelos de Imagem
```
C:\ai\tersa\app\actions\image\replicate.ts
‚îú‚îÄ‚îÄ Configura√ß√£o de modelos
‚îú‚îÄ‚îÄ Par√¢metros de gera√ß√£o
‚îî‚îÄ‚îÄ Processamento de resultados
```

### Componentes de Interface
```
C:\ai\tersa\components\nodes\image\
‚îú‚îÄ‚îÄ transform.tsx (interface principal)
‚îú‚îÄ‚îÄ primitive.tsx (componente base)
‚îî‚îÄ‚îÄ index.ts (exports)
```

### Schemas e Valida√ß√£o
```
C:\ai\tersa\lib\model-schemas.ts
‚îú‚îÄ‚îÄ Schemas de valida√ß√£o
‚îú‚îÄ‚îÄ Tipos de dados
‚îî‚îÄ‚îÄ Configura√ß√µes de campos
```

## üìã Checklist para Modifica√ß√µes

### Para Adicionar Novo Modelo de Texto:
1. ‚úÖ Atualizar `AVAILABLE_MODELS` em `components/nodes/text/transform.tsx`
2. ‚úÖ Verificar compatibilidade com API em `app/api/replicate-stream/route.ts`
3. ‚úÖ Atualizar schemas se necess√°rio em `lib/model-schemas.ts`

### Para Adicionar Novo Modelo de Imagem:
1. ‚úÖ Modificar `app/actions/image/replicate.ts`
2. ‚úÖ Atualizar componente em `components/nodes/image/transform.tsx`
3. ‚úÖ Verificar schemas em `lib/model-schemas.ts`

### Para Modificar APIs:
1. ‚úÖ Texto: `app/api/replicate-stream/route.ts`
2. ‚úÖ Imagem: `app/actions/image/replicate.ts`
3. ‚úÖ Atualizar tipos e interfaces relacionadas

## üö® Pontos de Aten√ß√£o

### Depend√™ncias Cr√≠ticas
- **Replicate API:** Todos os modelos usam a API do Replicate
- **Streaming:** Implementa√ß√£o customizada para texto
- **Schemas:** Valida√ß√£o centralizada em `model-schemas.ts`

### Arquivos Relacionados (Confirmados)
- `lib/gateway.tsx` - Configura√ß√µes de gateway
- `providers/gateway/` - Providers de API
- `schema.ts` - Schemas gerais do projeto
- `lib/models/vision.ts` - Modelos de vis√£o para an√°lise de imagem
- `lib/models/video/replicate.ts` - Modelos de v√≠deo via Replicate
- `lib/providers.ts` - Defini√ß√µes de provedores (Replicate, etc.)
- `app/actions/image/describe.ts` - Action para descri√ß√£o de imagens
- `app/api/replicate-stream/route.ts` - API de streaming de texto

## üîç Detalhamento Adicional

### 4. Modelos de Vis√£o (An√°lise de Imagem)

#### Configura√ß√£o dos Modelos de Vis√£o
**Arquivo:** `C:\ai\tersa\lib\models\vision.ts`
```typescript
export const visionModels: Record<string, TersaVisionModel> = {
  'replicate-gpt-5': {
    label: 'GPT-5',
    chef: providers.replicate,
    providers: [providers.replicate],
    replicateModel: 'openai/gpt-5',
    default: true,
  },
  'replicate-gpt-5-mini': {
    label: 'GPT-5 Mini',
    chef: providers.replicate,
    providers: [providers.replicate],
    replicateModel: 'openai/gpt-5-mini',
  },
  'replicate-claude-4-sonnet': {
    label: 'Claude 4 Sonnet',
    chef: providers.replicate,
    providers: [providers.replicate],
    replicateModel: 'anthropic/claude-4-sonnet',
  },
};
```

#### Action para Descri√ß√£o de Imagem
**Arquivo:** `C:\ai\tersa\app\actions\image\describe.ts`
- Usa modelos de vis√£o para analisar imagens
- Suporte a GPT e Claude para an√°lise visual
- Processamento de URLs e convers√£o base64

### 5. Modelos de V√≠deo

#### Configura√ß√£o dos Modelos de V√≠deo
**Arquivo:** `C:\ai\tersa\lib\models\video\replicate.ts`
- Modelos Kling via Replicate
- Suporte a diferentes vers√µes (v1.5, v1.6, v2.0)
- Configura√ß√µes de dura√ß√£o e aspect ratio

### 6. Provedores de API

#### Defini√ß√µes de Provedores
**Arquivo:** `C:\ai\tersa\lib\providers.ts`
- Configura√ß√£o do provedor Replicate
- √çcones e metadados dos provedores
- Tipos e interfaces para modelos

## üìã Mapeamento Completo de Arquivos

### Modelos de Texto
```
C:\ai\tersa\components\nodes\text\transform.tsx
‚îú‚îÄ‚îÄ AVAILABLE_MODELS (linhas 57-75)
‚îú‚îÄ‚îÄ getDefaultModel() 
‚îú‚îÄ‚îÄ handleGenerate() (streaming personalizado)
‚îî‚îÄ‚îÄ Configura√ß√£o de input para Replicate

C:\ai\tersa\app\api\replicate-stream\route.ts
‚îú‚îÄ‚îÄ Endpoint POST para streaming
‚îú‚îÄ‚îÄ Processamento de system_prompt
‚îú‚îÄ‚îÄ Suporte a image_input
‚îî‚îÄ‚îÄ Streaming de resposta
```

### Modelos de Imagem
```
C:\ai\tersa\components\nodes\image\transform.tsx
‚îú‚îÄ‚îÄ AVAILABLE_MODELS (linhas 43-100+)
‚îÇ   ‚îú‚îÄ‚îÄ black-forest-labs/flux-dev
‚îÇ   ‚îú‚îÄ‚îÄ black-forest-labs/flux-krea-dev
‚îÇ   ‚îî‚îÄ‚îÄ black-forest-labs/flux-1.1-pro
‚îú‚îÄ‚îÄ Configura√ß√£o de aspectRatios por modelo
‚îî‚îÄ‚îÄ Integra√ß√£o com model-schemas.ts

C:\ai\tersa\app\actions\image\replicate.ts
‚îú‚îÄ‚îÄ generateImageReplicateAction()
‚îú‚îÄ‚îÄ Processamento de par√¢metros por modelo
‚îú‚îÄ‚îÄ Upload para Supabase
‚îî‚îÄ‚îÄ Atualiza√ß√£o do projeto

C:\ai\tersa\lib\model-schemas.ts
‚îú‚îÄ‚îÄ MODEL_SCHEMAS por modelo
‚îú‚îÄ‚îÄ Campos din√¢micos (seed, guidance, etc.)
‚îú‚îÄ‚îÄ getModelSchema()
‚îî‚îÄ‚îÄ getModelDefaults()
```

### Modelos de Vis√£o
```
C:\ai\tersa\lib\models\vision.ts
‚îú‚îÄ‚îÄ visionModels (GPT-5, Claude)
‚îú‚îÄ‚îÄ Configura√ß√£o replicateModel
‚îî‚îÄ‚îÄ Provedores por modelo

C:\ai\tersa\app\actions\image\describe.ts
‚îú‚îÄ‚îÄ describeAction()
‚îú‚îÄ‚îÄ Processamento de imagem (base64)
‚îú‚îÄ‚îÄ Diferencia√ß√£o GPT vs Claude
‚îî‚îÄ‚îÄ Chamada direta ao Replicate
```

### Modelos de V√≠deo
```
C:\ai\tersa\lib\models\video\replicate.ts
‚îú‚îÄ‚îÄ Modelos Kling (v1.5 a v2.0)
‚îú‚îÄ‚îÄ Configura√ß√£o de input
‚îî‚îÄ‚îÄ Processamento de output
```

## üìù Notas para Agentes de IA

1. **Sempre verificar** os arquivos listados acima antes de fazer modifica√ß√µes
2. **Manter consist√™ncia** entre schemas, componentes e APIs
3. **Testar** tanto a interface quanto as chamadas de API ap√≥s modifica√ß√µes
4. **Documentar** novas adi√ß√µes neste arquivo
5. **Verificar compatibilidade** entre modelos GPT e Claude (diferentes formatos de input)
6. **Considerar schemas din√¢micos** ao adicionar novos modelos de imagem

---

**√öltima atualiza√ß√£o:** Documento criado para mapear a arquitetura atual de modelos e APIs.
**Respons√°vel:** Documenta√ß√£o autom√°tica do sistema.